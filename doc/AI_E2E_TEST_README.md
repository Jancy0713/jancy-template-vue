# AI E2E 测试规则文档

## 测试环境配置

### 端口规范

- E2E 测试服务器使用 `617x` 系列端口（6174, 6175, 6176, 6177, 6178）
- 默认端口为 `6174`
- 与开发服务器（`517x` 系列）端口区分开，避免冲突

### 测试配置文件

- 主配置文件：`playwright.ai-debug.config.ts`
- 测试运行脚本：`scripts/run-ai-e2e-tests.mjs`

## 测试执行流程

### 1. 启动测试

使用以下命令启动 E2E 测试：

```bash
node scripts/run-ai-e2e-tests.mjs
```

### 2. 测试流程

1. 启动测试服务器（自动使用 6174 端口）
2. 等待服务器就绪（健康检查）
3. 执行测试用例
4. 生成测试报告
5. 启动报告服务器

### 3. 错误处理

- 如果测试失败，查看测试报告和错误信息
- 根据错误信息修改相关代码
- 重新运行测试验证修改

## 测试报告

### 报告访问

- 测试完成后自动启动报告服务器
- 报告地址：`http://localhost:9323`

### 报告内容

- 测试执行结果
- 失败用例截图
- 测试视频记录
- 错误追踪信息

## 调试指南

### 常见问题处理

1. 端口占用：

   - 检查 `vite.config.ts` 中的端口配置
   - 确保使用 6174 端口

2. 元素定位问题：

   - 使用更具体的选择器
   - 添加适当的等待时间
   - 检查元素状态（可见性、可交互性）

3. 测试超时：
   - 检查 `CONFIG.TEST_TIMEOUT` 设置
   - 检查网络请求等待时间
   - 确保所有异步操作都有合适的等待机制

### 代码修改流程

1. 修改代码
2. 运行测试验证
3. 如果测试仍然失败，查看报告分析原因
4. 重复以上步骤直到测试通过

## 注意事项

1. 不要手动修改测试端口配置
2. 保持测试用例的独立性
3. 合理使用 API 模拟（mock）
4. 添加适当的等待机制
5. 使用明确的元素选择器

## 配置参数说明

### 超时设置

```javascript
const CONFIG = {
  SERVER_START_TIMEOUT: 10000, // 服务器启动超时时间（毫秒）
  TEST_TIMEOUT: 300000, // 测试执行超时时间（5分钟）
  HEALTH_CHECK_INTERVAL: 1000, // 健康检查间隔（毫秒）
  MAX_RETRIES: 3, // 最大重试次数
  TEST_RETRY_COUNT: 2, // 测试重试次数
}
```

### 端口配置

```javascript
const CONFIG = {
  SERVER_PORTS: [6174, 6175, 6176, 6177, 6178], // 可用端口列表
}
```

## 最佳实践

1. 测试用例编写

   - 保持用例简单明确
   - 一个用例只测试一个功能点
   - 使用合适的断言
   - 添加清晰的注释

2. 错误处理

   - 添加适当的错误捕获
   - 提供有意义的错误信息
   - 记录关键操作日志

3. 性能优化

   - 合理设置超时时间
   - 避免不必要的等待
   - 优化选择器性能

4. 维护性
   - 保持代码整洁
   - 遵循命名规范
   - 及时更新文档
